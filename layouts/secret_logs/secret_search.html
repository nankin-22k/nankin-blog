{{- define "main" }}

<header class="page-header">
    <h1>{{- (printf "%s&nbsp;" .Title ) | htmlUnescape -}}
        <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="11" cy="11" r="8"></circle>
            <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
        </svg>
    </h1>
    {{- if .Description }}
    <div class="post-description">
        {{ .Description }}
    </div>
    {{- end }}
    {{- if not (.Param "hideMeta") }}
    <div class="post-meta">
        {{- partial "translation_list.html" . -}}
    </div>
    {{- end }}
</header>

<div id="searchbox">
    <input id="searchInput" autofocus placeholder="{{ .Params.placeholder | default (printf "%s ↵" .Title) }}"
        aria-label="search" type="search" autocomplete="off" maxlength="64">
    <ul id="searchResults" aria-label="search results"></ul>
</div>

<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2"></script>
<script>
    const searchIndexUrl = "/nankin-blog/restricted-area/secret_search/index.json";
    let fuse;

    // 1. JSONデータを取得して検索エンジンを初期化する
    async function loadSearchIndex() {
        try {
            const response = await fetch(searchIndexUrl);
            const data = await response.json();
            
            const options = {
                shouldSort: true,
                threshold: 0.4,
                keys: ["title", "content", "summary"]
            };
            fuse = new Fuse(data, options);
            console.log("Secret search index loaded.");
        } catch (e) {
            console.error("Failed to load search index:", e);
        }
    }

    // 2. 検索を実行して結果を表示する
    function executeSearch(query) {
        const results = fuse.search(query);
        const searchResults = document.getElementById("searchResults");
        searchResults.innerHTML = ""; // クリア

        if (results.length === 0) {
            searchResults.innerHTML = "<li>No results found</li>";
            return;
        }

        results.forEach(result => {
            const item = result.item;
            const li = document.createElement("li");
            li.className = "post-entry";
            li.innerHTML = `
                <header class="entry-header">
                    <h2><a href="${item.permalink}">${item.title}</a></h2>
                </header>
                <div class="entry-content">
                    <p>${item.summary.replace(/<[^>]*>?/gm, '').substring(0, 150)}...</p>
                </div>
            `;
            searchResults.appendChild(li);
        });
    }

    // 3. イベントリスナーの設定
    window.addEventListener('DOMContentLoaded', () => {
        loadSearchIndex();

        const searchInput = document.getElementById("searchInput");
        if (searchInput) {
            searchInput.addEventListener("input", (e) => {
                const query = e.target.value;
                if (query.length > 1) {
                    executeSearch(query);
                } else {
                    document.getElementById("searchResults").innerHTML = "";
                }
            });
        }
    });
</script>
{{- end }}{{/* end main */}}